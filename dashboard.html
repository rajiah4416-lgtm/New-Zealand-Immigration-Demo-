<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Republic of Albania - Consular Service Portal</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
    <style>
        :root { --alb-red: #e41e20; --alb-black: #0a0a0a; --bg-gray: #f8f9fa; }
        body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; background: var(--bg-gray); margin: 0; padding: 40px; color: #333; }
        
        .portal-wrapper { max-width: 1000px; margin: auto; background: #fff; border-radius: 8px; box-shadow: 0 15px 35px rgba(0,0,0,0.1); overflow: hidden; border-top: 8px solid var(--alb-red); }
        
        .portal-header { background: #fff; padding: 30px; border-bottom: 1px solid #eee; display: flex; justify-content: space-between; align-items: center; }
        .portal-header h1 { margin: 0; font-size: 1.5rem; text-transform: uppercase; letter-spacing: 1px; color: var(--alb-black); }
        .portal-header p { margin: 5px 0 0; color: var(--alb-red); font-weight: 700; font-size: 0.85rem; }

        .form-section { padding: 40px; }
        .input-grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: 25px; }
        
        .field-group { display: flex; flex-direction: column; }
        label { font-size: 0.7rem; font-weight: 800; text-transform: uppercase; color: #666; margin-bottom: 8px; letter-spacing: 0.5px; }
        input, select { padding: 12px; border: 1px solid #ced4da; border-radius: 4px; font-size: 0.9rem; transition: border-color 0.2s; }
        input:focus { border-color: var(--alb-red); outline: none; }

        .btn-container { margin-top: 40px; padding: 0 40px 40px; }
        .generate-btn { background: var(--alb-red); color: white; border: none; padding: 18px; width: 100%; cursor: pointer; font-weight: 800; font-size: 1rem; text-transform: uppercase; border-radius: 5px; transition: background 0.3s; }
        .generate-btn:hover { background: #c01a1c; }

        #preview-pane { margin-top: 10px; border: 2px dashed #ddd; width: 140px; height: 175px; display: flex; align-items: center; justify-content: center; background: #fafafa; overflow: hidden; }
        #preview-pane img { width: 100%; height: 100%; object-fit: cover; }
        #qr-cache { display: none; }
    </style>
</head>
<body>

<div class="portal-wrapper">
    <div class="portal-header">
        <div>
            <h1>Republika e Shqipërisë</h1>
            <p>MINISTRY OF EUROPE AND FOREIGN AFFAIRS | MISSION: KARACHI</p>
        </div>
        <img src="https://upload.wikimedia.org/wikipedia/commons/thumb/d/d7/Coat_of_arms_of_Albania.svg/1200px-Coat_of_arms_of_Albania.svg.png" style="height: 70px;">
    </div>

    <div class="form-section">
        <div class="input-grid">
            <div class="field-group">
                <label>Surname, Given Name</label>
                <input type="text" id="full_name" placeholder="E.G. DEUBA, DEVENDRA">
                
                <label style="margin-top:20px;">Date of Birth</label>
                <input type="date" id="dob">
                
                <label style="margin-top:20px;">Nationality</label>
                <select id="nationality">
                    <option value="PAKISTAN">PAKISTAN</option>
                    <option value="INDIA">INDIA</option>
                    <option value="OTHER">OTHER</option>
                </select>
            </div>

            <div class="field-group">
                <label>Passport Number</label>
                <input type="text" id="passport_no" placeholder="PA1212320">
                
                <label style="margin-top:20px;">Visa Category</label>
                <select id="visa_type">
                    <option value="D">TYPE D (LONG STAY)</option>
                    <option value="C">TYPE C (SHORT STAY)</option>
                </select>

                <label style="margin-top:20px;">Application Reference</label>
                <input type="text" id="app_ref" placeholder="BUC-1302240902...">
            </div>

            <div class="field-group">
                <label>Issue Date</label>
                <input type="date" id="issue_date">
                
                <label style="margin-top:20px;">Applicant Photo</label>
                <input type="file" id="photo_input" accept="image/*" onchange="handlePhoto(event)">
                <div id="preview-pane">
                    <span id="placeholder-text" style="font-size: 0.6rem; color: #999;">NO IMAGE</span>
                    <img id="photo_img" style="display:none;">
                </div>
            </div>
        </div>
    </div>

    <div class="btn-container">
        <button class="generate-btn" onclick="processVisa()">Finalize and Download E-Visa</button>
    </div>
</div>

<div id="qr-cache"></div>

<script>
    let base64Photo = "";

    function handlePhoto(e) {
        const file = e.target.files[0];
        const reader = new FileReader();
        reader.onload = () => {
            base64Photo = reader.result;
            document.getElementById('photo_img').src = base64Photo;
            document.getElementById('photo_img').style.display = 'block';
            document.getElementById('placeholder-text').style.display = 'none';
        };
        reader.readAsDataURL(file);
    }

    async function processVisa() {
        const { jsPDF } = window.jspdf;
        const doc = new jsPDF();
        
        const rawName = document.getElementById('full_name').value.toUpperCase() || "NAME NOT PROVIDED";
        const passport = document.getElementById('passport_no').value.toUpperCase() || "N/A";
        const dob = document.getElementById('dob').value || "1990-01-01";
        const issueDate = document.getElementById('issue_date').value || "2026-01-01";
        const appRef = document.getElementById('app_ref').value || "BUC-" + Math.random().toString().slice(2,12);

        // Professional PDF Architecture
        doc.setLineWidth(0.4);
        doc.rect(5, 5, 200, 287); // Frame
        
        // Header Section
        doc.setFontSize(9);
        doc.setFont("times", "normal");
        doc.text("Electronic-Visa REPUBLIC OF ALBANIA", 10, 15);
        doc.text("A100018340e", 195, 12, {align: "right"});
        doc.setFont("times", "bold");
        doc.text(appRef, 195, 18, {align: "right"});

        // Central National Emblem (Mockup)
        doc.setFillColor(228, 30, 32);
        doc.rect(98, 12, 14, 14, 'F'); 
        doc.line(5, 32, 205, 32);

        // Photo Integration
        if(base64Photo) {
            doc.addImage(base64Photo, 'JPEG', 15, 45, 38, 48);
        } else {
            doc.rect(15, 45, 38, 48);
        }

        // Professional Field Placement (Dual Language)
        doc.setFontSize(8);
        doc.setFont("times", "normal");
        
        const config = [
            ["E VLEFSHME PER / VALID FOR", "ALBANIA"],
            ["NGA / FROM", issueDate],
            ["DERI / UNTIL", "ONE YEAR FROM ISSUE"],
            ["TIPI VIZES / TYPE OF VISA", document.getElementById('visa_type').value],
            ["NUMRI I PASAPORTES / PASSPORT NO.", passport],
            ["MBIEMER, EMER / SURNAME, NAME", rawName],
            ["LESHUAR NE / ISSUED IN", "KARACHI (Istanbul Consular Mission)"],
            ["SHENIME / REMARKS", "NONE"]
        ];

        let yPos = 48;
        config.forEach(item => {
            doc.setFont("times", "normal");
            doc.text(item[0], 65, yPos);
            doc.setFont("times", "bold");
            doc.text(item[1], 115, yPos);
            yPos += 11;
        });

        // MRZ Generation (Machine Readable Zone)
        doc.setFont("courier", "bold");
        doc.setFontSize(11);
        const nameClean = rawName.replace(/, /g, "<<").replace(/ /g, "<");
        const mrz1 = `P<ALB${nameClean}<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<`.substring(0, 44);
        const dobClean = dob.replace(/-/g, '').slice(2);
        const mrz2 = `${passport}<<<${dobClean}M3301236753003196<<<<08`.substring(0, 44);
        
        doc.text(mrz1, 10, 165);
        doc.text(mrz2, 10, 175);

        // QR Code Implementation
        const qrDiv = document.getElementById("qr-cache");
        qrDiv.innerHTML = "";
        new QRCode(qrDiv, { text: "ALB-EVISA-VERIFY-" + appRef, width: 128, height: 128 });

        setTimeout(() => {
            const qrCanvas = qrDiv.querySelector('canvas');
            if(qrCanvas) {
                doc.addImage(qrCanvas.toDataURL("image/png"), 'PNG', 15, 240, 35, 35);
            }
            
            doc.setFont("times", "italic");
            doc.setFontSize(7);
            doc.text("Note: This document is generated and sealed by an automatic procedure in", 60, 255);
            doc.text("an electronic system (Ministry for Europe and Foreign Affairs)", 60, 260);
            
            doc.save(`Albania_Evisa_${rawName.replace(/ /g, '_')}.pdf`);
        }, 500);
    }
</script>
</body>
</html>
