<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
    <style>
        :root { --alb-red: #e41e20; --alb-black: #050505; --gold-seal: #d4af37; }
        body { font-family: 'Times New Roman', serif; background: #f0f0f0; margin: 0; }
        
        header { background: white; border-bottom: 6px solid var(--alb-red); padding: 15px 5%; display: flex; justify-content: space-between; align-items: center; }
        .state-title h1 { margin: 0; color: var(--alb-black); font-size: 1.4rem; text-transform: uppercase; }
        .state-title p { margin: 0; color: var(--alb-red); font-size: 0.9rem; font-weight: bold; }
        .harp-icon { height: 70px; }

        .time-banner { background: var(--alb-black); color: white; text-align: center; padding: 8px; font-weight: bold; font-size: 0.8rem; border-bottom: 3px solid var(--gold-seal); }

        .patch { display: none; padding: 25px; animation: fadeIn 0.4s ease; }
        .patch.active { display: block; }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }

        .container { max-width: 1150px; margin: auto; background: white; padding: 35px; border-radius: 2px; box-shadow: 0 10px 30px rgba(0,0,0,0.15); border-left: 10px solid var(--alb-red); }
        
        .grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: 20px; }
        label { display: block; font-weight: bold; color: #222; font-size: 0.75rem; margin-bottom: 5px; text-transform: uppercase; }
        input, select { width: 100%; padding: 10px; border: 1px solid #bbb; border-radius: 2px; font-size: 0.95rem; }
        
        .btn-main { background: var(--alb-red); color: white; border: none; padding: 15px; width: 100%; cursor: pointer; font-weight: bold; margin-top: 20px; transition: 0.3s; }
        .btn-main:hover { background: #b00; }
        
        table { width: 100%; border-collapse: collapse; margin-top: 30px; }
        th { background: #f8f8f8; color: var(--alb-red); padding: 12px; text-align: left; border-bottom: 2px solid #000; font-size: 0.8rem; }
        td { padding: 12px; border-bottom: 1px solid #eee; font-size: 0.9rem; }
        
        .status { padding: 3px 8px; font-weight: bold; font-size: 0.7rem; border-radius: 2px; }
        .approved { background: #d1fae5; color: #065f46; }
        .waiting { background: #fef3c7; color: #92400e; }
        
        #qrcode { margin-top: 15px; display: inline-block; padding: 10px; border: 1px solid #eee; }
        #photo_prev { width: 140px; height: 170px; border: 2px solid #000; object-fit: cover; margin-top: 10px; }
    </style>
</head>
<body>

<header>
    <div style="width: 60px; height: 40px; background: var(--alb-red); border: 1px solid #000;"></div>
    <div class="state-title" style="text-align:center;">
        <h1>Republika e Shqipërisë</h1>
        <p>CONSULAR SECTION ISTANBUL | KARACHI JURISDICTION</p>
    </div>
    <img src="https://upload.wikimedia.org/wikipedia/commons/thumb/d/d7/Coat_of_arms_of_Albania.svg/1200px-Coat_of_arms_of_Albania.svg.png" class="harp-icon">
</header>
<div class="time-banner" id="clock">SYNCING TIRANA TIME...</div>

<div id="patch1" class="patch active">
    <div class="container">
        <h2 style="color:var(--alb-red); border-bottom: 1px solid #ddd; padding-bottom: 10px;">Consular Registry Hub - Karachi</h2>
        <div class="grid">
            <div>
                <label>Manual ALB Ref Number</label><input type="text" id="ref" placeholder="ALB-99234X">
                <label>Applicant Full Name</label><input type="text" id="name">
                <label>Date of Birth</label><input type="date" id="dob">
                <label>Nationality</label>
                <select id="nation">
                    <option>Pakistan</option>
                    <option>India</option>
                    <option>Other</option>
                </select>
            </div>
            <div>
                <label>Passport Number</label><input type="text" id="pass">
                <label>Submission Date</label><input type="date" id="s_date">
                <label>Visa Issue Date</label><input type="date" id="i_date">
                <label>Visa Category</label>
                <select id="cat">
                    <option>Type D - Employment</option>
                    <option>Type C - Tourism</option>
                    <option>Type D - Business</option>
                </select>
            </div>
            <div>
                <label>Decision</label><select id="status"><option>Waiting</option><option>Approved</option><option>Refusal</option></select>
                <label>Applicant Photo</label><input type="file" onchange="processPic(event)">
                <img id="photo_prev" style="display:none;">
            </div>
        </div>
        <button class="btn-main" onclick="saveRecord()">REGISTER APPLICATION</button>

        <table>
            <thead><tr><th>ALB Ref</th><th>Name</th><th>Nationality</th><th>Status</th><th>Action</th></tr></thead>
            <tbody id="list"></tbody>
        </table>
    </div>
</div>

<div id="patch2" class="patch"><div class="container" id="inspect_box"></div><button class="btn-main" onclick="showPatch(3)">VIEW STATEMENT</button></div>
<div id="patch3" class="patch"><div class="container" style="text-align:center;"><div id="stmt" style="font-size:1.5rem; padding:40px;"></div><button class="btn-main" onclick="showPatch(4)">GENERATE DIPLOMATIC PDF</button></div></div>

<div id="patch4" class="patch">
    <div class="container" style="text-align: center;">
        <h2 style="color:var(--alb-red);">Document Verification Portal</h2>
        <div id="card_ui" style="text-align:left; border:2px solid #000; padding:20px; background:#fffdfa;"></div>
        <div id="qrcode"></div>
        <button class="btn-main" onclick="generatePDF()">DOWNLOAD SEALED PDF WITH QR CODE</button>
    </div>
</div>

<script>
    function clock() {
        const opt = { timeZone: 'Europe/Tirane', hour: '2-digit', minute: '2-digit', second: '2-digit', day: 'numeric', month: 'short', year: 'numeric' };
        document.getElementById('clock').innerHTML = "TIRANA OFFICIAL TIME: " + new Date().toLocaleString('en-GB', opt).toUpperCase();
    }
    setInterval(clock, 1000);

    let db = JSON.parse(localStorage.getItem('alb_karachi_db')) || [];
    let activeIdx = null;
    let imgData = "";

    function processPic(e) {
        const reader = new FileReader();
        reader.onload = () => { imgData = reader.result; document.getElementById('photo_prev').src = imgData; document.getElementById('photo_prev').style.display='block'; };
        reader.readAsDataURL(e.target.files[0]);
    }

    function saveRecord() {
        const r = {
            ref: document.getElementById('ref').value || "ALB-" + Math.floor(Math.random()*900000),
            name: document.getElementById('name').value,
            dob: document.getElementById('dob').value,
            nation: document.getElementById('nation').value,
            pass: document.getElementById('pass').value,
            s_date: document.getElementById('s_date').value,
            i_date: document.getElementById('i_date').value,
            cat: document.getElementById('cat').value,
            status: document.getElementById('status').value,
            photo: imgData
        };
        db.push(r); localStorage.setItem('alb_karachi_db', JSON.stringify(db)); render();
    }

    function render() {
        const l = document.getElementById('list'); l.innerHTML = '';
        db.forEach((r, i) => {
            l.innerHTML += `<tr><td><b>${r.ref}</b></td><td>${r.name}</td><td>${r.nation}</td><td><span class="status ${r.status.toLowerCase()}">${r.status}</span></td><td><button onclick="view(${i})">Open</button> <button onclick="del(${i})">X</button></td></tr>`;
        });
    }

    function del(i) { db.splice(i,1); localStorage.setItem('alb_karachi_db', JSON.stringify(db)); render(); }

    function view(i) {
        activeIdx = i; const r = db[i];
        document.getElementById('inspect_box').innerHTML = `<div style="display:flex; gap:30px;"><img src="${r.photo}" style="width:200px;"><div><h2>${r.name}</h2><p>DOB: ${r.dob}</p><p>REF: ${r.ref}</p></div></div>`;
        document.getElementById('stmt').innerText = r.status === "Approved" ? "The Republic of Albania hereby grants entry authorization." : "Application is under mandatory state review.";
        
        document.getElementById('card_ui').innerHTML = `<h3>Viza Shqiptare</h3><p>REF: ${r.ref}</p><p>HOLDER: ${r.name}</p><p>ISSUE DATE: ${r.i_date}</p>`;
        
        // Generate QR Code
        document.getElementById('qrcode').innerHTML = "";
        new QRCode(document.getElementById("qrcode"), { text: "VERIFIED: " + r.ref + " NAME: " + r.name, width: 100, height: 100 });
        
        showPatch(2);
    }

    function showPatch(n) { document.querySelectorAll('.patch').forEach(p => p.classList.remove('active')); document.getElementById('patch'+n).classList.add('active'); }

    async function generatePDF() {
        const r = db[activeIdx];
        const { jsPDF } = window.jspdf;
        const doc = new jsPDF();
        
        doc.setFillColor(228, 30, 32); doc.rect(0, 0, 210, 45, 'F');
        doc.setTextColor(255); doc.setFontSize(18); doc.text("REPUBLIKA E SHQIPËRISË", 105, 20, {align:'center'});
        doc.setFontSize(10); doc.text("CONSULAR SECTION ISTANBUL | JURISDICTION: KARACHI, PAKISTAN", 105, 30, {align:'center'});

        doc.setTextColor(0);
        if(r.photo) doc.addImage(r.photo, 'JPEG', 155, 50, 38, 48);
        
        doc.setFont("times", "bold"); doc.text(`REF: ${r.ref}`, 20, 60);
        doc.setFont("times", "normal");
        doc.text(`Full Name: ${r.name}`, 20, 75);
        doc.text(`Date of Birth: ${r.dob}`, 20, 83);
        doc.text(`Nationality: ${r.nation}`, 20, 91);
        doc.text(`Passport: ${r.pass}`, 20, 99);
        doc.text(`Submission Date: ${r.s_date}`, 20, 107);
        doc.text(`Issue Date: ${r.i_date}`, 20, 115);

        // Add QR Code to PDF
        const qrCanvas = document.querySelector('#qrcode canvas');
        if(qrCanvas) doc.addImage(qrCanvas.toDataURL("image/png"), 'PNG', 20, 130, 30, 30);
        
        doc.text("Official Digital Verification Seal", 20, 165);
        doc.setFontSize(9); doc.text("Scan QR code to verify the authenticity of this document via the Ministry of Interior portal.", 20, 170);

        doc.setFont("times", "bold"); doc.text("Authorized Consular Officer,", 20, 200);
        doc.line(20, 205, 80, 205);
        doc.save(`Albania_Karachi_${r.name}.pdf`);
    }

    render(); clock();
</script>
</body>
    </html>
