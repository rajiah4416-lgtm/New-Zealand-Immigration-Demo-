<!DOCTYPE html>
<html lang="ga">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <title>Inimirce Éireann | Embassy Portal</title>
    <style>
        :root { --isd-green: #004d44; --gold: #b8860b; --ie-green: #169B62; --ie-orange: #FF883E; }
        body { font-family: 'Times New Roman', serif; background: #f4f6f5; margin: 0; color: #333; }
        
        header { background: #fff; padding: 12px 5%; border-bottom: 5px solid var(--isd-green); display: flex; justify-content: space-between; align-items: center; }
        .flag-icon { display: flex; width: 45px; height: 25px; border: 1px solid #ccc; }
        .f-g { background: var(--ie-green); flex: 1; } .f-w { background: #fff; flex: 1; } .f-o { background: var(--ie-orange); flex: 1; }
        .header-title { text-align: center; color: var(--isd-green); font-weight: bold; line-height: 1.2; }

        .time-bar { background: var(--isd-green); color: white; text-align: center; padding: 6px; font-weight: bold; font-size: 0.85rem; letter-spacing: 1px; }
        
        .patch { display: none; min-height: 90vh; padding: 20px; }
        .patch.active { display: block; }

        .container { max-width: 900px; margin: auto; background: white; padding: 30px; border-top: 6px solid var(--gold); box-shadow: 0 4px 15px rgba(0,0,0,0.1); }
        h2 { color: var(--isd-green); border-bottom: 2px solid var(--gold); padding-bottom: 8px; font-size: 1.1rem; text-transform: uppercase; }

        .grid-form { display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin-bottom: 20px; }
        label { display: block; font-weight: bold; font-size: 0.85rem; color: var(--isd-green); margin-bottom: 5px; }
        input, select { width: 100%; padding: 10px; border: 1px solid #ccc; box-sizing: border-box; font-family: serif; }

        .btn { background: var(--isd-green); color: white; border: none; padding: 15px; width: 100%; font-weight: bold; cursor: pointer; text-transform: uppercase; margin-top: 10px; }
        .btn-gold { background: var(--gold); }

        table { width: 100%; border-collapse: collapse; margin-top: 20px; font-size: 0.9rem; }
        th { background: #f8f9fa; padding: 12px; text-align: left; border-bottom: 2px solid var(--isd-green); }
        td { padding: 12px; border-bottom: 1px solid #eee; }
        .status-pill { padding: 4px 8px; border-radius: 3px; font-weight: bold; font-size: 0.7rem; color: white; text-transform: uppercase; }
    </style>
</head>
<body>

<header>
    <div class="flag-icon"><div class="f-g"></div><div class="f-w"></div><div class="f-o"></div></div>
    <div class="header-title">AMBASÁID NA hÉIREANN<br><small>EMBASSY OF IRELAND | IMMIGRATION SERVICE</small></div>
    <div id="liveClock" style="font-size: 11px; font-weight: bold; color: var(--isd-green); width: 150px; text-align: right;"></div>
</header>
<div class="time-bar">DUBLIN LIVE IMMIGRATION PORTAL</div>

<div id="patch1" class="patch active">
    <div class="container">
        <h2>Patch 1: Registration & Current Registry</h2>
        <div class="grid-form">
            <div><label>Full Name</label><input type="text" id="name" placeholder="Client Name"></div>
            <div><label>Passport Number</label><input type="text" id="pass" placeholder="Passport No"></div>
            <div><label>Date of Birth</label><input type="date" id="dob"></div>
            <div><label>Visa Category</label>
                <select id="visa">
                    <option>General Employment Permit</option>
                    <option>Critical Skills Employment</option>
                    <option>Study Visa (Stamp 2)</option>
                </select>
            </div>
            <div><label>Country</label><select id="country"><option>Pakistan</option><option>India</option></select></div>
            <div><label>Decision Status</label>
                <select id="status">
                    <option value="Waiting">Waiting</option>
                    <option value="Approved">Approved</option>
                    <option value="Refusal">Refusal</option>
                </select>
            </div>
        </div>
        <button class="btn" onclick="saveData()">Save & Sync to Registry</button>

        <h2 style="margin-top: 40px;">Active Client Registry</h2>
        <table>
            <thead><tr><th>Name</th><th>Passport</th><th>Status</th><th>Action</th></tr></thead>
            <tbody id="registryBody"></tbody>
        </table>
    </div>
</div>

<div id="patch2" class="patch">
    <div class="container">
        <h2>Patch 2: Case Inspection</h2>
        <div id="inspectDisplay" style="line-height: 2; border: 1px solid #ddd; padding: 20px; margin-bottom: 20px;"></div>
        <button class="btn" onclick="showPatch(3)">Proceed to Document Generation</button>
        <button class="btn btn-gold" onclick="showPatch(1)">Back to Registry</button>
    </div>
</div>

<div id="patch3" class="patch">
    <div class="container" style="text-align: center;">
        <h2>Patch 3: Official Issuance</h2>
        <div style="font-size: 4rem; margin: 20px;">☘️</div>
        <p>The official Immigration Delivery Service letter is ready for signature and download.</p>
        <button class="btn" onclick="generatePDF()">Download Signed Official PDF</button>
        <button class="btn btn-gold" onclick="showPatch(1)">New Session</button>
    </div>
</div>

<script>
    function clock() {
        const opt = { timeZone: 'Europe/Dublin', hour: '2-digit', minute: '2-digit', second: '2-digit', day: 'numeric', month: 'short', year: 'numeric' };
        document.getElementById('liveClock').innerHTML = new Date().toLocaleString('en-IE', opt).toUpperCase();
    }
    setInterval(clock, 1000);

    let db = JSON.parse(localStorage.getItem('isd_final_v6')) || [];
    let selectedIdx = null;

    function showPatch(n) {
        document.querySelectorAll('.patch').forEach(p => p.classList.remove('active'));
        document.getElementById('patch'+n).classList.add('active');
        if(n===1) renderRegistry();
    }

    function saveData() {
        const r = {
            name: document.getElementById('name').value,
            pass: document.getElementById('pass').value,
            dob: document.getElementById('dob').value,
            visa: document.getElementById('visa').value,
            country: document.getElementById('country').value,
            status: document.getElementById('status').value,
            time: new Date().toLocaleString('en-IE', { timeZone: 'Europe/Dublin' })
        };
        if(!r.name || !r.pass) return alert("Missing Information");
        db.push(r);
        localStorage.setItem('isd_final_v6', JSON.stringify(db));
        renderRegistry();
    }

    function renderRegistry() {
        const body = document.getElementById('registryBody');
        body.innerHTML = '';
        // Sort: Waiting first
        const order = { "Waiting": 1, "Approved": 2, "Refusal": 3 };
        db.sort((a,b) => order[a.status] - order[b.status]);

        db.forEach((r, i) => {
            const bg = r.status==='Approved'?'#169B62':(r.status==='Refusal'?'#d9534f':'#f0ad4e');
            body.innerHTML += `<tr>
                <td><b>${r.name}</b></td>
                <td>${r.pass}</td>
                <td><span class="status-pill" style="background:${bg}">${r.status}</span></td>
                <td><button onclick="inspect(${i})">Inspect</button></td>
            </tr>`;
        });
    }

    function inspect(i) {
        selectedIdx = i;
        const r = db[i];
        document.getElementById('inspectDisplay').innerHTML = `
            <b>Client:</b> ${r.name}<br><b>Passport:</b> ${r.pass}<br>
            <b>Category:</b> ${r.visa}<br><b>Decision:</b> ${r.status.toUpperCase()}<br>
            <b>Portal Entry:</b> ${r.time}
        `;
        showPatch(2);
    }

    function generatePDF() {
        const r = db[selectedIdx];
        const { jsPDF } = window.jspdf;
        const doc = new jsPDF();
        
        doc.setFont("times", "bold");
        doc.text("IMMIGRATION SERVICE DELIVERY (ISD)", 105, 20, null, null, "center");
        doc.setFontSize(10);
        doc.text("An Roinn Dlí agus Cirt | Department of Justice", 105, 27, null, null, "center");
        
        doc.setFontSize(12); doc.setFont("times", "normal");
        doc.text(`Date: ${new Date().toLocaleDateString('en-IE')}`, 20, 50);
        doc.text(`Passport: ${r.pass}`, 20, 60);
        doc.text(`Applicant: ${r.name}`, 20, 70);
        
        doc.setFont("times", "bold");
        doc.text(`Decision Status: ${r.status.toUpperCase()}`, 20, 90);
        
        doc.setFont("times", "normal");
        let body = `I refer to your application for a ${r.visa}. As outlined in your portal, our Dublin office (ISD) has processed this file. `;
        if(r.status === 'Refusal') body += "Based on the documentation provided, the application is hereby refused.";
        else if(r.status === 'Approved') body += "Your application has been successful. Please retain this for border control.";
        else body += "Your application is currently being held for further assessment.";

        doc.text(doc.splitTextToSize(body, 170), 20, 105);

        // Seal & Signature
        doc.setDrawColor(0, 77, 68); doc.ellipse(170, 160, 15, 15);
        doc.setFontSize(7); doc.text("OFFICIAL MARK", 160, 161);
        
        doc.setFontSize(12); doc.text("Yours sincerely,", 20, 200);
        doc.text("DL", 20, 210);
        doc.setFont("times", "bold"); doc.text("Immigration Service Delivery Ireland", 20, 215);

        doc.save(`${r.name}_Official_Decision.pdf`);
    }

    renderRegistry(); clock();
</script>
</body>
</html>
