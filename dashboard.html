<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <title>Embassy of Ireland | Karachi Mission</title>
    <style>
        :root { --isd-green: #004d44; --gold: #b8860b; --light-bg: #f9f9f9; }
        body { font-family: 'Times New Roman', Times, serif; background: #e0e4e3; margin: 0; }
        
        /* Navigation & Header */
        header { background: white; border-bottom: 5px solid var(--isd-green); padding: 15px; display: flex; justify-content: space-between; align-items: center; }
        .time-bar { background: var(--isd-green); color: white; text-align: center; padding: 5px; font-weight: bold; font-size: 0.8rem; }
        
        .patch { display: none; padding: 20px; animation: fadeIn 0.3s; }
        .patch.active { display: block; }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }

        .card { background: white; max-width: 900px; margin: auto; padding: 30px; border-top: 5px solid var(--gold); box-shadow: 0 10px 25px rgba(0,0,0,0.2); }
        
        /* Grid Layout for Form */
        .form-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 15px; }
        label { display: block; font-weight: bold; color: var(--isd-green); margin-top: 10px; font-size: 0.85rem; }
        input, select { width: 100%; padding: 8px; border: 1px solid #ccc; box-sizing: border-box; }
        
        .btn { background: var(--isd-green); color: white; border: none; padding: 15px; width: 100%; cursor: pointer; font-weight: bold; text-transform: uppercase; margin-top: 20px; }
        .btn-danger { background: #8b0000; margin-top: 5px; padding: 5px; font-size: 0.7rem; }

        /* Registry Table */
        table { width: 100%; border-collapse: collapse; margin-top: 15px; background: white; }
        th { background: var(--isd-green); color: white; padding: 10px; text-align: left; font-size: 0.8rem; }
        td { padding: 10px; border-bottom: 1px solid #ddd; font-size: 0.85rem; }
        
        .status-pill { padding: 3px 8px; border-radius: 10px; font-weight: bold; font-size: 0.7rem; color: white; }
        .waiting { background: var(--gold); }
        .approved { background: #169B62; }
        .refusal { background: #d9534f; }

        #photoPreview { width: 100px; height: 120px; border: 2px dashed #ccc; margin-top: 10px; object-fit: cover; }
    </style>
</head>
<body>

<header>
    <img src="https://www.dfa.ie/media/dfa/styleassets/images/logo.png" alt="Irish Coat of Arms" style="height: 50px;">
    <div style="text-align: center;">
        <strong style="color: var(--isd-green);">AMBASÁID NA hÉIREANN</strong><br>
        <small>EMBASSY OF IRELAND, KARACHI - VISA OFFICE</small>
    </div>
    <div style="width: 50px;"></div>
</header>
<div class="time-bar" id="liveClock">Dublin Live: Loading...</div>

<div id="patch1" class="patch active">
    <div class="card">
        <h2>Patch 1: Mission Registry & Entry</h2>
        <div class="form-grid">
            <div>
                <label>Full Name</label><input type="text" id="name">
                <label>Father's Name</label><input type="text" id="fatherName">
                <label>Passport Number</label><input type="text" id="passNo">
                <label>Gender</label>
                <select id="gender"><option>Male</option><option>Female</option></select>
                <label>Nationality</label>
                <select id="nation"><option>Pakistan</option><option>India</option><option>Other</option></select>
                <label>Visa Category</label>
                <select id="visaCat">
                    <option value="C-Short Stay">Category C (Short Stay)</option>
                    <option value="D-Long Stay">Category D (Long Stay)</option>
                    <option value="General Employment Permit">Work Permit - General</option>
                </select>
            </div>
            <div>
                <label>Passport Issue Date</label><input type="date" id="passIssue">
                <label>Passport Expiry Date</label><input type="date" id="passExpiry">
                <label>Visa Approval Date (If applicable)</label><input type="date" id="visaDate">
                <label>Duration of Stay (Days)</label><input type="number" id="duration" placeholder="e.g. 90">
                <label>Decision Status</label>
                <select id="status"><option>Waiting</option><option>Approved</option><option>Refusal</option></select>
                <label>Upload Client Photo</label>
                <input type="file" id="photoInput" accept="image/*" onchange="previewImg()">
                <img id="photoPreview" src="">
            </div>
        </div>
        <button class="btn" onclick="saveRecord()">Sync & Add to Database</button>

        <h3 style="margin-top:40px; color: var(--isd-green);">Active Embassy List</h3>
        <table id="clientTable">
            <thead>
                <tr>
                    <th>Entry Date</th>
                    <th>Name</th>
                    <th>Passport</th>
                    <th>Status</th>
                    <th>Action</th>
                </tr>
            </thead>
            <tbody id="registryBody"></tbody>
        </table>
    </div>
</div>

<div id="patch2" class="patch">
    <div class="card">
        <h2>Patch 2: Embassy Inspection</h2>
        <div id="inspectionView" style="display:flex; gap: 20px;">
            </div>
        <button class="btn" onclick="showPatch(3)">Review Official Statement</button>
        <button class="btn btn-gold" onclick="showPatch(1)" style="background:var(--gold)">Back to Registry</button>
    </div>
</div>

<div id="patch3" class="patch">
    <div class="card" style="text-align: center;">
        <h2>Patch 3: Mission Statement</h2>
        <div id="encouragementMsg" style="padding: 20px; font-style: italic; font-size: 1.2rem; color: var(--isd-green);"></div>
        <button class="btn" onclick="showPatch(4)">Generate Final Visa Documents</button>
    </div>
</div>

<div id="patch4" class="patch">
    <div class="card" style="text-align: center;">
        <h2>Patch 4: Document Finalization</h2>
        <div id="visaSample" style="border: 4px solid var(--isd-green); padding: 15px; background: #fdfdfd; margin-bottom: 20px; text-align: left;">
            </div>
        <button class="btn" onclick="downloadPDF()">Download Sealed Irish Embassy PDF</button>
        <button class="btn btn-gold" style="background:var(--gold)" onclick="showPatch(1)">New Session</button>
    </div>
</div>

<script>
    function updateClock() {
        const opt = { timeZone: 'Europe/Dublin', hour: '2-digit', minute: '2-digit', second: '2-digit', day: 'numeric', month: 'short', year: 'numeric' };
        document.getElementById('liveClock').innerHTML = "DUBLIN LIVE | EMBASSY SERVER: " + new Date().toLocaleString('en-IE', opt).toUpperCase();
    }
    setInterval(updateClock, 1000);

    let db = JSON.parse(localStorage.getItem('isd_karachi_db')) || [];
    let selectedIdx = null;
    let base64Img = "";

    function previewImg() {
        const file = document.getElementById('photoInput').files[0];
        const reader = new FileReader();
        reader.onloadend = function() {
            base64Img = reader.result;
            document.getElementById('photoPreview').src = base64Img;
        }
        if (file) reader.readAsDataURL(file);
    }

    function showPatch(p) {
        document.querySelectorAll('.patch').forEach(div => div.classList.remove('active'));
        document.getElementById('patch' + p).classList.add('active');
        if(p === 1) renderRegistry();
    }

    function saveRecord() {
        const r = {
            name: document.getElementById('name').value,
            father: document.getElementById('fatherName').value,
            pass: document.getElementById('passNo').value,
            gender: document.getElementById('gender').value,
            nation: document.getElementById('nation').value,
            category: document.getElementById('visaCat').value,
            pIssue: document.getElementById('passIssue').value,
            pExpiry: document.getElementById('passExpiry').value,
            vDate: document.getElementById('visaDate').value,
            duration: document.getElementById('duration').value,
            status: document.getElementById('status').value,
            photo: base64Img,
            submissionDate: new Date().toLocaleDateString('en-GB')
        };
        if(!r.name || !r.pass) return alert("Fill Name and Passport.");
        db.push(r);
        localStorage.setItem('isd_karachi_db', JSON.stringify(db));
        renderRegistry();
    }

    function renderRegistry() {
        const body = document.getElementById('registryBody');
        body.innerHTML = '';
        // Sort: Waiting first
        const sortOrder = { "Waiting": 1, "Approved": 2, "Refusal": 3 };
        db.sort((a,b) => sortOrder[a.status] - sortOrder[b.status]);

        db.forEach((r, i) => {
            body.innerHTML += `<tr>
                <td>${r.submissionDate}</td>
                <td><b>${r.name}</b></td>
                <td>${r.pass}</td>
                <td><span class="status-pill ${r.status.toLowerCase()}">${r.status}</span></td>
                <td>
                    <button onclick="inspect(${i})">View</button>
                    <button class="btn-danger" onclick="deleteClient(${i})">Cut</button>
                </td>
            </tr>`;
        });
    }

    function deleteClient(i) {
        if(confirm("Cut client from registry?")) {
            db.splice(i, 1);
            localStorage.setItem('isd_karachi_db', JSON.stringify(db));
            renderRegistry();
        }
    }

    function inspect(i) {
        selectedIdx = i;
        const r = db[i];
        document.getElementById('inspectionView').innerHTML = `
            <img src="${r.photo || ''}" style="width:150px; border:2px solid var(--isd-green)">
            <div>
                <p><strong>Name:</strong> ${r.name} (${r.gender})</p>
                <p><strong>Passport:</strong> ${r.pass} (Exp: ${r.pExpiry})</p>
                <p><strong>Visa Category:</strong> ${r.category}</p>
                <p><strong>Status:</strong> ${r.status}</p>
            </div>
        `;

        let msg = "";
        if(r.status === "Approved") msg = "We are pleased to inform you that your journey to Ireland is about to begin. Your contributions are welcomed.";
        else if(r.status === "Refusal") msg = "While we cannot grant this request today, we encourage you to strengthen your application and look forward to your future interest in Ireland.";
        else msg = "Your application is being handled with the utmost care by our officers. We appreciate your patience during this process.";
        
        document.getElementById('encouragementMsg').innerText = msg;
        
        // Render Visa Sample
        document.getElementById('visaSample').innerHTML = `
            <div style="background:var(--isd-green); color:white; padding:5px; font-weight:bold;">VISA / VÍOSA - IRELAND</div>
            <p><strong>Type:</strong> ${r.category} | <strong>No:</strong> IE${Math.floor(Math.random()*999999)}</p>
            <p><strong>Holder:</strong> ${r.name.toUpperCase()} | <strong>Sex:</strong> ${r.gender.charAt(0)}</p>
            <p><strong>Duration:</strong> ${r.duration} Days | <strong>Valid From:</strong> ${r.vDate || 'Pending'}</p>
            <p style="font-size:10px; color:#666;">Issued by Embassy of Ireland, Karachi Mission.</p>
        `;
        showPatch(2);
    }

    function downloadPDF() {
        const r = db[selectedIdx];
        const { jsPDF } = window.jspdf;
        const doc = new jsPDF();
        
        doc.setFillColor(0, 77, 68); doc.rect(0, 0, 210, 40, 'F');
        doc.setTextColor(255, 255, 255); doc.setFontSize(16);
        doc.text("EMBASSY OF IRELAND | KARACHI", 105, 25, {align: 'center'});

        doc.setTextColor(0); doc.setFontSize(10);
        if(r.photo) doc.addImage(r.photo, 'JPEG', 150, 50, 40, 50);

        doc.setFont("times", "bold"); doc.text(`DECISION: ${r.status.toUpperCase()}`, 20, 55);
        doc.setFont("times", "normal");
        doc.text(`Applicant: ${r.name}`, 20, 65);
        doc.text(`Father's Name: ${r.father}`, 20, 72);
        doc.text(`Passport: ${r.pass} (Issued: ${r.pIssue} / Exp: ${r.pExpiry})`, 20, 79);
        doc.text(`Category: ${r.category}`, 20, 86);
        doc.text(`Requested on: ${r.submissionDate} | Decided: ${new Date().toLocaleDateString()}`, 20, 93);
        
        doc.setFont("times", "italic");
        const body = document.getElementById('encouragementMsg').innerText;
        doc.text(doc.splitTextToSize(body, 120), 20, 110);

        doc.setFont("times", "bold");
        doc.text("Visa Officer Signature", 20, 160);
        doc.line(20, 165, 80, 165);
        doc.text("Immigration Service Delivery (ISD)", 20, 172);

        doc.save(`${r.name}_Ireland_Visa.pdf`);
    }

    renderRegistry(); updateClock();
</script>
</body>
</html>
