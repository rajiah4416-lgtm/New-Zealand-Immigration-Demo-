const canvas = document.getElementById('signature-canvas');
    const signaturePad = new SignaturePad(canvas);
    const globalRef = "NZ-AUTH-" + Math.floor(100000 + Math.random() * 899999);

    function sync() {
        const val = (id) => document.getElementById(id).value || '---';
        
        document.getElementById('out-name').innerText = val('c-name');
        document.getElementById('out-name2').innerText = val('c-name');
        document.getElementById('out-passport').innerText = val('c-passport');
        document.getElementById('out-dob').innerText = val('c-dob');
        document.getElementById('out-salary').innerText = val('c-salary');
        document.getElementById('out-cat').innerText = document.getElementById('c-cat').value;
        document.getElementById('out-co-name').innerText = val('co-name');
        document.getElementById('out-co-name2').innerText = val('co-name');
        document.getElementById('out-co-num').innerText = val('co-num');
        document.getElementById('out-co-tax').innerText = val('co-tax');
        document.getElementById('out-co-addr').innerText = val('co-addr');
        document.getElementById('out-ref').innerText = globalRef;
        document.getElementById('out-ref2').innerText = globalRef;

        const qrContent = `REF: ${globalRef} - EMP: ${val('c-name')} - NZBN: ${val('co-num')}`;
        document.getElementById('out-qr').src = `https://api.qrserver.com/v1/create-qr-code/?size=150x150&data=${encodeURIComponent(qrContent)}`;
    }

    async function download() {
        // 1. Sync the signature
        if (!signaturePad.isEmpty()) {
            document.getElementById('out-sig').src = signaturePad.toDataURL();
        }

        // 2. Short delay to ensure images (Sig/QR) are rendered by the browser
        await new Promise(resolve => setTimeout(resolve, 500));

        const element = document.getElementById('pdf-export');
        const fileName = `NZ_Agreement_${document.getElementById('c-name').value || 'Final'}.pdf`;
        
        const opt = {
            margin: 0,
            filename: fileName,
            image: { type: 'jpeg', quality: 0.98 },
            html2canvas: { 
                scale: 2, 
                useCORS: true,
                letterRendering: true
            },
            jsPDF: { unit: 'mm', format: 'a4', orientation: 'portrait' }
        };

        // 3. Complete worker chain with explicit page trimming
        html2pdf().set(opt).from(element).toPdf().get('pdf').then(function(pdf) {
            const totalPages = pdf.internal.getNumberOfPages();
            // Remove any pages beyond the 3nd one
            if (totalPages > 3) {
                for (let i = totalPages; i > 3; i--) {
                    pdf.deletePage(i);
                }
            }
        }).save();
    }
    
    sync();<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>NZ Official Employment Agreement</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/signature_pad@4.0.0/dist/signature_pad.umd.min.js"></script>
    <style>
        :root { --nz-blue: #00247D; --nz-red: #CC142B; --text: #1a1a1a; }
        body { font-family: Arial, sans-serif; background: #555; margin: 0; padding: 20px; }
        
        #ui-panel { background: white; max-width: 900px; margin: 0 auto 30px; padding: 25px; border-radius: 8px; box-shadow: 0 10px 30px rgba(0,0,0,0.5); }
        .grid { display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 15px; }
        input, select { padding: 10px; border: 1px solid #ccc; border-radius: 4px; width: 100%; box-sizing: border-box; }
        .btn-main { background: #00247D; color: white; border: none; padding: 18px; border-radius: 5px; cursor: pointer; font-weight: bold; width: 100%; margin-top: 20px; font-size: 18px; text-transform: uppercase; }
        
        /* PDF Container - Hidden from view but ready for export */
        #pdf-export { width: 210mm; background: white; font-family: 'Times New Roman', serif; color: var(--text); }
        .page { 
            height: 297mm; 
            width: 210mm; 
            padding: 20mm; 
            box-sizing: border-box; 
            position: relative; 
            border-top: 15px solid var(--nz-blue); 
            border-bottom: 15px solid var(--nz-red); 
            overflow: hidden; 
        }
        
        .govt-header { text-align: center; border-bottom: 3px double var(--nz-blue); margin-bottom: 25px; padding-bottom: 10px; }
        .nz-logo { width: 120px; position: absolute; top: 20mm; right: 20mm; opacity: 0.9; }
        .watermark { position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%) rotate(-45deg); font-size: 100px; color: rgba(0, 36, 125, 0.05); white-space: nowrap; pointer-events: none; font-weight: bold; z-index: 0; }
        
        h2 { color: var(--nz-blue); font-size: 20px; border-bottom: 1px solid #ddd; margin-top: 25px; }
        p, li { font-size: 13.5px; text-align: justify; margin: 8px 0; line-height: 1.5; }
        table { width: 100%; border-collapse: collapse; margin: 15px 0; }
        td { border: 1px solid #aaa; padding: 10px; font-size: 13px; }
        .label { background: #f8f8f8; font-weight: bold; width: 35%; color: #333; }
        
        .sig-container { display: flex; justify-content: space-between; margin-top: 50px; }
        .sig-box { width: 45%; border-top: 2px solid #000; text-align: center; padding-top: 10px; }
        .sig-canvas-ui { border: 2px dashed var(--nz-blue); width: 100%; height: 120px; background: #fff; margin-top: 10px; cursor: crosshair; }
        .qr-section { display: flex; align-items: center; gap: 20px; margin-top: 40px; border: 1px solid #eee; padding: 15px; }
    </style>
</head>
<body>

<div id="ui-panel">
    <h2 style="margin-top:0; border:none; color:#1a1a1a;">ðŸ‡³ðŸ‡¿ New Zealand Employment Agreement Wizard</h2>
    <div class="grid">
        <input type="text" id="c-name" placeholder="Full Legal Name" oninput="sync()">
        <input type="text" id="c-passport" placeholder="Passport Number" oninput="sync()">
        <input type="date" id="c-dob" oninput="sync()">
        <input type="text" id="c-country" placeholder="Country of Origin" oninput="sync()">
        <input type="text" id="c-salary" placeholder="Hourly Rate (e.g. $31.50)" oninput="sync()">
        <select id="c-cat" onchange="sync()">
            <option value="Restaurant Waiter">Restaurant Waiter</option>
            <option value="Cleaner Worker">Cleaner Worker</option>
            <option value="Mart Worker">Mart Worker</option>
            <option value="General Labourer">General Labourer</option>
        </select>
        <input type="text" id="co-name" placeholder="NZ Company Name" oninput="sync()">
        <input type="text" id="co-num" placeholder="NZBN (13 digits)" oninput="sync()">
        <input type="text" id="co-tax" placeholder="IRD Number" oninput="sync()">
        <input type="text" id="co-addr" placeholder="Registered NZ Address" oninput="sync()">
    </div>
    
    <div style="margin-top:20px;">
        <label><b>Client Signature (Touch or Mouse):</b></label>
        <canvas id="signature-canvas" class="sig-canvas-ui"></canvas>
        <button onclick="signaturePad.clear()" style="padding:5px 15px; cursor:pointer;">Clear Canvas</button>
    </div>
    
    <button class="btn-main" onclick="download()">Generate 3-Page Official PDF</button>
</div>

<div id="pdf-export">
    <div class="page" style="page-break-after: always;">
        <div class="watermark">OFFICIAL DOCUMENT</div>
        <img src="https://upload.wikimedia.org/wikipedia/commons/3/3e/Flag_of_New_Zealand.svg" class="nz-logo">
        <div class="govt-header">
            <h1 style="margin:0; font-size: 26px; color: var(--nz-blue);">EMPLOYMENT AGREEMENT</h1>
            <p style="margin:0; font-weight:bold; letter-spacing: 2px;">IN ACCORDANCE WITH THE EMPLOYMENT RELATIONS ACT 2000</p>
        </div>

        <div style="border-left: 5px solid var(--nz-red); padding-left: 15px; background: #f9f9f9; padding: 10px;">
            <strong>Ref No:</strong> <span id="out-ref">---</span><br>
            <strong>Date of Issue:</strong> February 15, 2026
        </div>

        <h2>1. PARTIES</h2>
        <table>
            <tr><td class="label">The Employer</td><td id="out-co-name">---</td></tr>
            <tr><td class="label">NZBN / IRD</td><td><span id="out-co-num">---</span> / <span id="out-co-tax">---</span></td></tr>
            <tr><td class="label">Employer Address</td><td id="out-co-addr">---</td></tr>
            <tr><td class="label">The Employee</td><td id="out-name">---</td></tr>
            <tr><td class="label">Passport / DOB</td><td><span id="out-passport">---</span> / <span id="out-dob">---</span></td></tr>
        </table>

        <h2>2. POSITION AND DUTIES</h2>
        <p>The Employer appoints the Employee to the position of <b><span id="out-cat">---</span></b>. The Employee shall perform duties consistent with this role.</p>
        
        <h2>3. TYPE OF AGREEMENT</h2>
        <p>This is an Individual Employment Agreement as required for the Accredited Employer Work Visa (AEWV) scheme. Both parties agree to act in good faith.</p>
    </div>

    <div class="page" style="page-break-after: always;">
        <div class="watermark">NEW ZEALAND LAW</div>
        <h2 style="margin-top:0;">4. REMUNERATION</h2>
        <p>The Employeeâ€™s base rate of pay shall be <b><span id="out-salary">---</span> per hour</b>. Wages will be paid weekly. The Employer will ensure all deductions for PAYE tax are made.</p>

        <h2>5. HOURS OF WORK</h2>
        <p>The Employee is guaranteed a minimum of **40 hours per week**. Any variations will be agreed upon in writing 48 hours in advance.</p>

        <h2>6. HOLIDAYS AND LEAVE</h2>
        <ul>
            <li><b>Annual Leave:</b> 4 weeksâ€™ paid annual holidays per year.</li>
            <li><b>Sick Leave:</b> 10 daysâ€™ paid sick leave per year.</li>
            <li><b>Public Holidays:</b> Paid at "Time and a Half" plus an alternative day off if worked.</li>
        </ul>

        <h2>7. KIWISAVER</h2>
        <p>Employer will make contributions to the Employee's KiwiSaver fund if eligible and enrolled.</p>
    </div>

    <div class="page">
        <div class="watermark">VALIDATED</div>
        <h2 style="margin-top:0;">8. HEALTH AND SAFETY</h2>
        <p>Both parties will comply with the Health and Safety at Work Act 2015. The Employer will provide a safe environment and PPE.</p>

        <h2>9. CONFIDENTIALITY AND PRIVACY</h2>
        <p>The Employee shall not disclose sensitive information. Data is protected under the Privacy Act 2020.</p>

        <h2>10. EXECUTION</h2>
        <p>By signing, both parties acknowledge agreement to all terms.</p>

        <div class="sig-container">
            <div class="sig-box">
                <img id="out-sig" style="width:180px; height:70px; object-fit:contain;">
                <p><b>Employee Signature</b><br><small id="out-name2">---</small></p>
            </div>
            <div class="sig-box">
                <div style="height:70px; border-bottom:1px dotted #aaa; margin-bottom:5px; font-family: 'Brush Script MT', cursive; font-size: 24px; color: var(--nz-blue);">
                    Employer Signed
                </div>
                <p><b>Company Authorized Signatory</b><br><small id="out-co-name2">---</small></p>
            </div>
        </div>

        <div class="qr-section">
            <img id="out-qr" style="width:120px; border:1px solid #ccc;">
            <div style="font-size:12px;">
                <strong>DIGITAL VERIFICATION</strong><br>
                Scan code to verify authenticity. <br>
                <strong>Ref:</strong> <span id="out-ref2">---</span><br>
                <strong>Status:</strong> <span style="color:green;">ACTIVE/VERIFIED</span>
            </div>
        </div>

        <div style="position:absolute; bottom:20mm; width:170mm; font-size:10px; color:#777; border-top:1px solid #ddd; padding-top:10px;">
            Ministry of Business, Innovation & Employment (MBIE) Compliance Office.<br>
            Verification Portal: employment.govt.nz
        </div>
    </div>
</div>

<script>
    const canvas = document.getElementById('signature-canvas');
    const signaturePad = new SignaturePad(canvas);
    const globalRef = "NZ-AUTH-" + Math.floor(100000 + Math.random() * 899999);

    function sync() {
        const val = (id) => document.getElementById(id).value || '---';
        document.getElementById('out-name').innerText = val('c-name');
        document.getElementById('out-name2').innerText = val('c-name');
        document.getElementById('out-passport').innerText = val('c-passport');
        document.getElementById('out-dob').innerText = val('c-dob');
        document.getElementById('out-salary').innerText = val('c-salary');
        document.getElementById('out-cat').innerText = document.getElementById('c-cat').value;
        document.getElementById('out-co-name').innerText = val('co-name');
        document.getElementById('out-co-name2').innerText = val('co-name');
        document.getElementById('out-co-num').innerText = val('co-num');
        document.getElementById('out-co-tax').innerText = val('co-tax');
        document.getElementById('out-co-addr').innerText = val('co-addr');
        document.getElementById('out-ref').innerText = globalRef;
        document.getElementById('out-ref2').innerText = globalRef;

        const qrContent = `REF: ${globalRef} - EMP: ${val('c-name')} - NZBN: ${val('co-num')}`;
        document.getElementById('out-qr').src = `https://api.qrserver.com/v1/create-qr-code/?size=150x150&data=${encodeURIComponent(qrContent)}`;
    }

    async function download() {
        if (!signaturePad.isEmpty()) {
            document.getElementById('out-sig').src = signaturePad.toDataURL();
        }
        
        const element = document.getElementById('pdf-export');
        const opt = {
            margin: 0,
            filename: `NZ_Agreement_${document.getElementById('c-name').value}.pdf`,
            image: { type: 'jpeg', quality: 0.98 },
            html2canvas: { scale: 2, useCORS: true },
            jsPDF: { unit: 'mm', format: 'a4', orientation: 'portrait' }
        };
        
        // Use the Worker API to manually trim extra pages
        html2pdf().set(opt).from(element).toPdf().get('pdf').then(function (pdf) {
            const totalPages = pdf.internal.getNumberOfPages();
            for (let i = totalPages; i > 3; i--) {
                pdf.deletePage(i);
            }
        }).save();
    }
    sync();
</script>

</body>
</html>
